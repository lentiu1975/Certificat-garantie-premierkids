<%- include('partials/header') %>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clock-history me-2"></i>Istoric Certificate Generate</span>
        <div class="d-flex gap-2">
            <input type="text" class="form-control form-control-sm" id="searchHistory"
                   placeholder="Caută factură sau client..." style="width: 250px;">
            <button class="btn btn-sm btn-outline-primary" id="refreshBtn">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Factură</th>
                        <th>Client</th>
                        <th>Tip Client</th>
                        <th>Data Factură</th>
                        <th>Comandă eMAG</th>
                        <th>Status eMAG</th>
                        <th>Generat La</th>
                        <th>Acțiuni</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 mb-0">Se încarcă istoricul...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center">
        <span id="historyCount" class="text-muted"></span>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

<%- include('partials/footer') %>

<script>
let allCertificates = [];
let currentPage = 1;
const perPage = 50;

document.addEventListener('DOMContentLoaded', function() {
    loadHistory();
    document.getElementById('searchHistory').addEventListener('keyup', filterHistory);
    document.getElementById('refreshBtn').addEventListener('click', loadHistory);
});

async function loadHistory() {
    try {
        const response = await fetch('/api/certificates?limit=500');
        const data = await response.json();
        allCertificates = data.certificates || [];
        renderHistory(allCertificates);
    } catch (error) {
        showAlert('Eroare la încărcarea istoricului: ' + error.message, 'danger');
    }
}

function renderHistory(certificates) {
    const tbody = document.getElementById('historyBody');
    document.getElementById('historyCount').textContent = certificates.length + ' certificate';

    if (certificates.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">Niciun certificat găsit</td></tr>';
        return;
    }

    // Paginare
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    const pageData = certificates.slice(start, end);

    tbody.innerHTML = pageData.map(cert => {
        const createdDate = new Date(cert.created_at);

        return '<tr>' +
            '<td><strong>' + escapeHtml(cert.invoice_number) + '</strong></td>' +
            '<td>' + escapeHtml(cert.client_name || '-') + '</td>' +
            '<td>' + (cert.client_is_vat_payer ? '<span class="badge bg-info">PJ</span>' : '<span class="badge bg-secondary">PF</span>') + '</td>' +
            '<td>' + escapeHtml(cert.invoice_date || '-') + '</td>' +
            '<td>' + (cert.emag_order_number ? escapeHtml(cert.emag_order_number) : '-') + '</td>' +
            '<td>' + (cert.emag_order_number ?
                (cert.emag_uploaded ? '<span class="badge bg-success">Încărcat</span>' : '<span class="badge bg-warning">Eroare</span>') :
                '-') + '</td>' +
            '<td>' + createdDate.toLocaleDateString('ro-RO') + ' ' + createdDate.toLocaleTimeString('ro-RO', {hour: '2-digit', minute: '2-digit'}) + '</td>' +
            '<td>' +
                '<a href="/api/certificates/' + cert.invoice_number + '/download" class="btn btn-sm btn-outline-primary" title="Descarcă PDF">' +
                    '<i class="bi bi-download"></i>' +
                '</a>' +
            '</td>' +
        '</tr>';
    }).join('');

    // Paginare
    renderPagination(certificates.length);
}

function renderPagination(total) {
    const totalPages = Math.ceil(total / perPage);
    const pagination = document.getElementById('pagination');

    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '';

    // Prev
    html += '<li class="page-item ' + (currentPage === 1 ? 'disabled' : '') + '">' +
            '<a class="page-link" href="#" onclick="goToPage(' + (currentPage - 1) + '); return false;">&laquo;</a></li>';

    // Pages
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += '<li class="page-item ' + (i === currentPage ? 'active' : '') + '">' +
                    '<a class="page-link" href="#" onclick="goToPage(' + i + '); return false;">' + i + '</a></li>';
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }

    // Next
    html += '<li class="page-item ' + (currentPage === totalPages ? 'disabled' : '') + '">' +
            '<a class="page-link" href="#" onclick="goToPage(' + (currentPage + 1) + '); return false;">&raquo;</a></li>';

    pagination.innerHTML = html;
}

function goToPage(page) {
    const totalPages = Math.ceil(allCertificates.length / perPage);
    if (page < 1 || page > totalPages) return;

    currentPage = page;
    renderHistory(filterCertificates());
}

function filterHistory() {
    currentPage = 1;
    renderHistory(filterCertificates());
}

function filterCertificates() {
    const search = document.getElementById('searchHistory').value.toLowerCase();

    if (!search) return allCertificates;

    return allCertificates.filter(cert =>
        (cert.invoice_number || '').toLowerCase().includes(search) ||
        (cert.client_name || '').toLowerCase().includes(search) ||
        (cert.emag_order_number || '').toLowerCase().includes(search)
    );
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
</body>
</html>
