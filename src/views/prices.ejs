<%- include('partials/header') %>

<!-- Toolbar -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span><i class="bi bi-currency-exchange me-2"></i>Management Prețuri</span>
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <!-- Curs valutar -->
                <div class="d-flex align-items-center gap-2 px-3 py-1 bg-light rounded">
                    <small class="text-muted">EUR:</small>
                    <strong id="rateEur" class="text-primary">-</strong>
                    <small class="text-muted ms-2">HUF:</small>
                    <strong id="rateHuf" class="text-primary">-</strong>
                    <button class="btn btn-sm btn-outline-secondary ms-2" id="refreshRatesBtn" title="Actualizează curs BNR">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>

                <!-- Acțiuni -->
                <button class="btn btn-primary me-2" id="addGroupBtn">
                    <i class="bi bi-plus-lg me-1"></i>Grup Nou
                </button>
                <div class="btn-group">
                    <button class="btn btn-outline-success" id="exportBtn">
                        <i class="bi bi-download me-1"></i>Export
                    </button>
                    <button class="btn btn-outline-warning" id="importBtn" data-bs-toggle="modal" data-bs-target="#importModal">
                        <i class="bi bi-upload me-1"></i>Import
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtre și Statistici -->
<div class="card mb-4">
    <div class="card-body py-3">
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Caută produs...">
                </div>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="filterStatus">
                    <option value="active" selected>Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="all">Toate</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="filterPrice">
                    <option value="all">Toate prețurile</option>
                    <option value="with_base">Cu preț bază</option>
                    <option value="without_base">Fără preț bază</option>
                    <option value="expired">Prețuri expirate</option>
                </select>
            </div>
            <div class="col-md-4">
                <div class="d-flex justify-content-end gap-2">
                    <span class="badge bg-primary fs-6" id="statTotal">0 grupuri</span>
                    <span class="badge bg-success fs-6" id="statWithPrice">0 cu preț</span>
                    <span class="badge bg-secondary fs-6" id="statInactive">0 inactive</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabel Prețuri -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
            <table class="table table-hover table-sm mb-0" id="pricesTable">
                <thead class="table-light sticky-top">
                    <tr id="tableHeader">
                        <th class="sticky-col bg-light" style="min-width: 280px; left: 0; z-index: 2;">
                            Produs
                            <small class="d-block text-muted fw-normal">Grupare automată</small>
                        </th>
                        <th style="min-width: 120px; text-align: right;">
                            Preț Bază
                            <small class="d-block text-muted fw-normal">RON</small>
                        </th>
                        <!-- Coloanele pentru canale se generează dinamic -->
                    </tr>
                </thead>
                <tbody id="pricesBody">
                    <tr>
                        <td colspan="10" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Se încarcă datele...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Import CSV -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-upload me-2"></i>Import Prețuri din CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Format CSV:</strong> Prima coloană trebuie să fie <code>group_name</code> (numele grupului),
                    a doua <code>base_price</code> (prețul de bază în RON), iar restul coloanelor cu denumirile canalelor.
                </div>
                <div class="mb-3">
                    <label class="form-label">Conținut CSV</label>
                    <textarea class="form-control font-monospace" id="csvInput" rows="10"
                              placeholder="group_name,base_price,Premierkids_RON,eMag_RON&#10;Jeep Wrangler 12V,1499,1599,1549"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Sau încarcă fișier</label>
                    <input type="file" class="form-control" id="csvFile" accept=".csv,.txt">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                <button type="button" class="btn btn-primary" id="doImportBtn">
                    <i class="bi bi-upload me-2"></i>Importă
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editare Grup -->
<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGroupModalLabel"><i class="bi bi-pencil me-2"></i>Editare Prețuri</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label" for="editGroupName">Nume Grup</label>
                        <input type="text" class="form-control" id="editGroupName" name="editGroupName" autocomplete="off" tabindex="1">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Preț Bază (RON)</label>
                        <input type="number" class="form-control" id="editBasePrice" step="0.01" min="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Produse în grup</label>
                        <input type="text" class="form-control" id="editProductsCount" readonly>
                    </div>
                </div>

                <h6 class="mb-3">Prețuri pe Canale</h6>
                <div class="table-responsive">
                    <table class="table table-bordered" id="editPricesTable">
                        <thead class="table-light">
                            <tr>
                                <th>Canal</th>
                                <th>Valută</th>
                                <th>TVA</th>
                                <th>Preț Sugerat</th>
                                <th>Preț Final</th>
                                <th>Fără TVA</th>
                                <th>Expiră la</th>
                            </tr>
                        </thead>
                        <tbody id="editPricesBody">
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <h6>Produse incluse în grup</h6>
                    <div id="groupProductsList" class="small" style="max-height: 150px; overflow-y: auto;"></div>

                    <!-- Adăugare produs nou -->
                    <div class="mt-2 p-2 bg-light rounded">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="newProductCode" placeholder="Cod SmartBill (ex: 6427470000011)">
                            <button class="btn btn-outline-primary" type="button" id="addProductBtn">
                                <i class="bi bi-plus-lg"></i> Adaugă
                            </button>
                        </div>
                        <small class="text-muted">Adaugă un produs existent din nomenclator la acest grup</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                <button type="button" class="btn btn-primary" id="saveGroupBtn">
                    <i class="bi bi-save me-2"></i>Salvează
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .sticky-col {
        position: sticky;
        left: 0;
        background: white;
    }
    #pricesTable tbody tr:hover .sticky-col {
        background: #f8f9fa;
    }
    .price-input {
        width: 100px;
        text-align: right;
    }
    .price-cell {
        cursor: pointer;
        transition: background 0.2s;
    }
    .price-cell:hover {
        background: #e9ecef !important;
    }
    .expired-price {
        background: #fff3cd !important;
    }
    .no-price {
        color: #999;
        font-style: italic;
    }
    .without-vat {
        font-size: 0.75rem;
        color: #666;
    }
</style>

<%- include('partials/footer') %>

<script>
let channels = [];
let groups = [];
let allGroups = []; // Include și inactive pentru statistici
let exchangeRates = {};
let currentEditGroupId = null;

// Funcție pentru afișarea alertelor
function showAlert(message, type = 'info') {
    // Creăm containerul dacă nu există
    let container = document.getElementById('alertContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'alertContainer';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        document.body.appendChild(container);
    }

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    container.appendChild(alertDiv);

    // Auto-închidere după 5 secunde
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 150);
    }, 5000);
}

document.addEventListener('DOMContentLoaded', async () => {
    await loadExchangeRates();
    await loadChannels();
    await loadGroups();

    // Event listeners - butoane toolbar
    document.getElementById('refreshRatesBtn').addEventListener('click', fetchNewRates);
    document.getElementById('addGroupBtn').addEventListener('click', openNewGroupModal);
    document.getElementById('exportBtn').addEventListener('click', exportPrices);
    document.getElementById('doImportBtn').addEventListener('click', importPrices);
    document.getElementById('saveGroupBtn').addEventListener('click', saveGroup);
    document.getElementById('addProductBtn').addEventListener('click', addProductToGroup);
    document.getElementById('newProductCode').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addProductToGroup();
    });
    document.getElementById('searchInput').addEventListener('input', filterTable);
    document.getElementById('filterStatus').addEventListener('change', loadGroups);
    document.getElementById('filterPrice').addEventListener('change', filterTable);
    document.getElementById('csvFile').addEventListener('change', loadCsvFile);

    // Fix pentru input în modal
    const editGroupModal = document.getElementById('editGroupModal');
    const nameInput = document.getElementById('editGroupName');

    // Oprește Bootstrap din a captura tastele în modal
    editGroupModal.addEventListener('keydown', function(e) {
        // Permite toate tastele în inputuri
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            e.stopPropagation();
        }
    }, true);

    // După ce modalul e complet deschis, dăm focus pe câmpul de nume
    editGroupModal.addEventListener('shown.bs.modal', function(e) {
        nameInput.focus();
        nameInput.select();
    });

    // Event delegation pentru tabelul de prețuri (click pe rânduri/butoane edit)
    document.getElementById('pricesTable').addEventListener('click', function(e) {
        // Găsim butonul sau celula click-uită
        const editBtn = e.target.closest('button[data-edit-group]');
        const toggleBtn = e.target.closest('button[data-toggle-active]');
        const deleteBtn = e.target.closest('button[data-delete-group]');
        const priceCell = e.target.closest('td.price-cell');
        const row = e.target.closest('tr[data-group-id]');

        if (editBtn) {
            const groupId = parseInt(editBtn.dataset.editGroup);
            editGroup(groupId);
        } else if (toggleBtn) {
            const groupId = parseInt(toggleBtn.dataset.toggleActive);
            toggleGroupActive(groupId);
        } else if (deleteBtn) {
            const groupId = parseInt(deleteBtn.dataset.deleteGroup);
            deleteGroupPermanent(groupId);
        } else if (priceCell && row) {
            const groupId = parseInt(row.dataset.groupId);
            editGroup(groupId);
        }
    });
});

async function loadExchangeRates() {
    try {
        const response = await fetch('/api/exchange-rates');
        if (!response.ok) {
            console.error('Eroare API exchange-rates:', response.status);
            return;
        }
        const data = await response.json();
        exchangeRates = data.rates || {};

        document.getElementById('rateEur').textContent = exchangeRates.EUR?.rate?.toFixed(4) || '-';
        document.getElementById('rateHuf').textContent = exchangeRates.HUF?.rate?.toFixed(4) || '-';
    } catch (error) {
        console.error('Eroare la încărcarea cursurilor:', error);
    }
}

async function loadChannels() {
    try {
        const response = await fetch('/api/price-channels');
        if (!response.ok) {
            console.error('Eroare API price-channels:', response.status);
            return;
        }
        const data = await response.json();
        channels = data.channels || [];
        renderTableHeader();
    } catch (error) {
        console.error('Eroare la încărcarea canalelor:', error);
    }
}

async function loadGroups() {
    try {
        const filterStatus = document.getElementById('filterStatus').value;
        const includeInactive = filterStatus === 'inactive' || filterStatus === 'all';

        const response = await fetch(`/api/product-groups?withPrices=true&includeInactive=${includeInactive}`);
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        const data = await response.json();
        let loadedGroups = data.groups || [];

        // Filtrăm în funcție de status
        if (filterStatus === 'active') {
            groups = loadedGroups.filter(g => g.is_active === 1);
        } else if (filterStatus === 'inactive') {
            groups = loadedGroups.filter(g => g.is_active === 0);
        } else {
            groups = loadedGroups;
        }

        // Încărcăm toate pentru statistici
        const allResponse = await fetch('/api/product-groups?withPrices=true&includeInactive=true');
        if (!allResponse.ok) {
            throw new Error(`API error: ${allResponse.status}`);
        }
        const allData = await allResponse.json();
        allGroups = allData.groups || [];

        renderTableBody();
        updateStats();
    } catch (error) {
        console.error('Eroare la încărcarea grupurilor:', error);
        document.getElementById('pricesBody').innerHTML =
            '<tr><td colspan="10" class="text-center py-5 text-danger">Eroare la încărcarea datelor</td></tr>';
    }
}

function renderTableHeader() {
    const headerRow = document.getElementById('tableHeader');
    // Păstrăm primele 2 coloane (Produs și Preț Bază)
    const existingCols = headerRow.querySelectorAll('th');
    while (existingCols.length > 2) {
        headerRow.removeChild(existingCols[existingCols.length - 1]);
    }

    // Adăugăm coloanele pentru canale
    channels.forEach(channel => {
        const th = document.createElement('th');
        th.style.minWidth = '120px';
        th.style.textAlign = 'right';
        th.innerHTML = `
            ${channel.name}
            <small class="d-block text-muted fw-normal">${channel.currency}${channel.show_without_vat ? ' + fără TVA' : ''}</small>
        `;
        headerRow.appendChild(th);
    });
}

function renderTableBody() {
    const tbody = document.getElementById('pricesBody');

    if (groups.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="${2 + channels.length}" class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="mt-2 text-muted">Nu există grupuri de produse.</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = groups.map(group => {
        const isInactive = !group.is_active;
        let row = `
            <tr data-group-id="${group.id}" data-group-name="${group.group_name.toLowerCase()}" data-is-active="${group.is_active}" class="${isInactive ? 'table-secondary' : ''}">
                <td class="sticky-col ${isInactive ? 'bg-light' : 'bg-white'}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong class="${isInactive ? 'text-muted' : ''}">${group.group_name}</strong>
                            <small class="d-block text-muted">
                                ${group.products_count || group.smartbill_codes?.length || 0} produse
                                ${isInactive ? '<span class="badge bg-secondary ms-1">Inactiv</span>' : ''}
                            </small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" data-edit-group="${group.id}" title="Editare">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn ${isInactive ? 'btn-outline-success' : 'btn-outline-secondary'}" data-toggle-active="${group.id}" title="${isInactive ? 'Activează' : 'Dezactivează'}">
                                <i class="bi ${isInactive ? 'bi-eye' : 'bi-eye-slash'}"></i>
                            </button>
                            <button class="btn btn-outline-danger" data-delete-group="${group.id}" title="Șterge permanent (EOL)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </td>
                <td class="text-end price-cell ${!group.base_price ? 'no-price' : ''}">
                    ${group.base_price ? formatPrice(group.base_price, 'RON') : '-'}
                </td>
        `;

        channels.forEach(channel => {
            const priceData = group.prices?.[channel.id];
            const hasPrice = priceData?.price > 0;
            const isExpired = priceData?.is_expired;

            let cellContent = '-';
            let cellClass = 'no-price';

            if (hasPrice) {
                cellContent = formatPrice(priceData.price, channel.currency);
                cellClass = isExpired ? 'expired-price' : '';

                if (channel.show_without_vat && priceData.price_without_vat) {
                    cellContent += `<br><span class="without-vat">fără TVA: ${priceData.price_without_vat.toFixed(4)}</span>`;
                }
            }

            row += `<td class="text-end price-cell ${cellClass}">${cellContent}</td>`;
        });

        row += '</tr>';
        return row;
    }).join('');
}

function formatPrice(price, currency) {
    if (!price) return '-';

    const formatter = new Intl.NumberFormat('ro-RO', {
        minimumFractionDigits: currency === 'HUF' ? 0 : 2,
        maximumFractionDigits: currency === 'HUF' ? 0 : 2
    });

    return formatter.format(price);
}

function updateStats() {
    const active = allGroups.filter(g => g.is_active === 1);
    const inactive = allGroups.filter(g => g.is_active === 0);
    const withPrice = active.filter(g => g.base_price > 0).length;

    document.getElementById('statTotal').textContent = `${active.length} active`;
    document.getElementById('statWithPrice').textContent = `${withPrice} cu preț`;
    document.getElementById('statInactive').textContent = `${inactive.length} inactive`;
}

function filterTable() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const filterPrice = document.getElementById('filterPrice').value;

    const rows = document.querySelectorAll('#pricesBody tr[data-group-id]');

    rows.forEach(row => {
        const name = row.dataset.groupName || '';
        const groupId = parseInt(row.dataset.groupId);
        const group = groups.find(g => g.id === groupId);

        let show = name.includes(search);

        if (show && filterPrice !== 'all') {
            if (filterPrice === 'with_base') {
                show = group?.base_price > 0;
            } else if (filterPrice === 'without_base') {
                show = !group?.base_price;
            } else if (filterPrice === 'expired') {
                show = Object.values(group?.prices || {}).some(p => p.is_expired);
            }
        }

        row.style.display = show ? '' : 'none';
    });
}

async function fetchNewRates() {
    const btn = document.getElementById('refreshRatesBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
        const response = await fetch('/api/exchange-rates/fetch', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            await loadExchangeRates();
            showAlert('Curs valutar actualizat cu succes!', 'success');
        } else {
            showAlert(data.error || 'Eroare la actualizarea cursului', 'danger');
        }
    } catch (error) {
        showAlert('Eroare: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
    }
}

function exportPrices() {
    window.location.href = '/api/prices/export';
}

function loadCsvFile(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('csvInput').value = e.target.result;
    };
    reader.readAsText(file);
}

async function importPrices() {
    const csvData = document.getElementById('csvInput').value.trim();
    if (!csvData) {
        showAlert('Introduceți date CSV', 'warning');
        return;
    }

    const btn = document.getElementById('doImportBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Se importă...';

    try {
        const response = await fetch('/api/prices/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ csvData })
        });

        const data = await response.json();

        if (data.success) {
            let msg = `Import finalizat: ${data.updated} prețuri actualizate.`;
            if (data.errors?.length) {
                msg += ` ${data.errors.length} erori.`;
            }
            showAlert(msg, data.errors?.length ? 'warning' : 'success');
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            await loadGroups();
        } else {
            showAlert(data.error || 'Eroare la import', 'danger');
        }
    } catch (error) {
        showAlert('Eroare: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-upload me-2"></i>Importă';
    }
}

function openNewGroupModal() {
    currentEditGroupId = null; // null = grup nou
    document.getElementById('editGroupName').value = '';
    document.getElementById('editBasePrice').value = '';
    document.getElementById('editProductsCount').value = '0';
    document.getElementById('groupProductsList').innerHTML = '<em class="text-muted">Salvează grupul și apoi poți adăuga produse</em>';

    // Render tabelul de prețuri gol
    const tbody = document.getElementById('editPricesBody');
    tbody.innerHTML = channels.map(channel => {
        return `
            <tr data-channel-id="${channel.id}">
                <td><strong>${channel.name}</strong></td>
                <td>${channel.currency}</td>
                <td>${channel.vat_rate}%</td>
                <td class="text-end text-muted">-</td>
                <td>
                    <input type="number" class="form-control form-control-sm price-input"
                           value="" step="0.01" min="0"
                           data-channel-id="${channel.id}">
                </td>
                <td class="text-end without-vat-display">-</td>
                <td>
                    <input type="date" class="form-control form-control-sm"
                           value=""
                           data-channel-id="${channel.id}" data-field="expires">
                </td>
            </tr>
        `;
    }).join('');

    // Adăugăm listener pentru a actualiza "fără TVA" live
    tbody.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', function() {
            const channelId = this.dataset.channelId;
            const channel = channels.find(c => c.id == channelId);
            const row = this.closest('tr');
            const vatDisplay = row.querySelector('.without-vat-display');

            if (channel && this.value) {
                const priceWithoutVat = parseFloat(this.value) / (1 + channel.vat_rate / 100);
                vatDisplay.textContent = channel.show_without_vat ? priceWithoutVat.toFixed(4) : '-';
            } else {
                vatDisplay.textContent = '-';
            }
        });
    });

    const modalEl = document.getElementById('editGroupModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}

async function editGroup(groupId) {
    currentEditGroupId = groupId;
    const group = groups.find(g => g.id === groupId);
    if (!group) return;

    document.getElementById('editGroupName').value = group.group_name;
    document.getElementById('editBasePrice').value = group.base_price || '';
    document.getElementById('editProductsCount').value = group.products_count || group.smartbill_codes?.length || 0;

    // Încarcă lista de produse (cu butoane de eliminare)
    await refreshProductsList(groupId);

    // Render tabelul de prețuri
    const tbody = document.getElementById('editPricesBody');
    tbody.innerHTML = channels.map(channel => {
        const priceData = group.prices?.[channel.id] || {};
        const suggestedPrice = calculateSuggestedPrice(group.base_price, channel.currency);

        return `
            <tr data-channel-id="${channel.id}">
                <td><strong>${channel.name}</strong></td>
                <td>${channel.currency}</td>
                <td>${channel.vat_rate}%</td>
                <td class="text-end text-muted">${suggestedPrice ? formatPrice(suggestedPrice, channel.currency) : '-'}</td>
                <td>
                    <input type="number" class="form-control form-control-sm price-input"
                           value="${priceData.price || ''}" step="0.01" min="0"
                           data-channel-id="${channel.id}">
                </td>
                <td class="text-end without-vat-display">
                    ${channel.show_without_vat && priceData.price_without_vat ? priceData.price_without_vat.toFixed(4) : '-'}
                </td>
                <td>
                    <input type="date" class="form-control form-control-sm"
                           value="${priceData.expires_at ? priceData.expires_at.split('T')[0] : ''}"
                           data-channel-id="${channel.id}" data-field="expires">
                </td>
            </tr>
        `;
    }).join('');

    // Adăugăm listener pentru a actualiza "fără TVA" live
    tbody.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', function() {
            const channelId = this.dataset.channelId;
            const channel = channels.find(c => c.id == channelId);
            const row = this.closest('tr');
            const vatDisplay = row.querySelector('.without-vat-display');

            if (channel && this.value) {
                const priceWithoutVat = parseFloat(this.value) / (1 + channel.vat_rate / 100);
                vatDisplay.textContent = channel.show_without_vat ? priceWithoutVat.toFixed(4) : '-';
            } else {
                vatDisplay.textContent = '-';
            }
        });
    });

    const modalEl = document.getElementById('editGroupModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}

function calculateSuggestedPrice(basePrice, currency) {
    if (!basePrice || !currency) return null;
    if (currency === 'RON') return basePrice;

    const rate = exchangeRates[currency]?.rate;
    if (!rate) return null;

    return basePrice / rate;
}

async function saveGroup() {
    const btn = document.getElementById('saveGroupBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Se salvează...';

    try {
        const groupName = document.getElementById('editGroupName').value.trim();
        const basePrice = parseFloat(document.getElementById('editBasePrice').value) || 0;

        if (!groupName) {
            showAlert('Numele grupului este obligatoriu', 'warning');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save me-2"></i>Salvează';
            return;
        }

        let groupId = currentEditGroupId;

        // Dacă e grup nou, îl creăm întâi
        if (!groupId) {
            const createResponse = await fetch('/api/product-groups', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group_name: groupName, base_price: basePrice })
            });

            const contentType = createResponse.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server-ul a returnat un răspuns invalid');
            }

            const createData = await createResponse.json();
            if (!createData.success) {
                throw new Error(createData.error || 'Eroare la creare grup');
            }
            groupId = createData.group.id;
            currentEditGroupId = groupId;
        } else {
            // Actualizăm grupul existent (inclusiv numele)
            await fetch(`/api/product-groups/${groupId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group_name: groupName, base_price: basePrice })
            });
        }

        // Salvăm prețurile pe canale
        const prices = [];
        document.querySelectorAll('#editPricesBody tr').forEach(row => {
            const channelId = row.dataset.channelId;
            const priceInput = row.querySelector('input[type="number"]');
            const expiresInput = row.querySelector('input[type="date"]');

            if (priceInput.value) {
                prices.push({
                    channel_id: parseInt(channelId),
                    price: parseFloat(priceInput.value),
                    expires_at: expiresInput.value || null
                });
            }
        });

        if (prices.length > 0) {
            await fetch(`/api/product-groups/${groupId}/prices`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prices })
            });
        }

        showAlert('Grup salvat cu succes!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editGroupModal')).hide();
        await loadGroups();
    } catch (error) {
        showAlert('Eroare: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-save me-2"></i>Salvează';
    }
}

async function toggleGroupActive(groupId) {
    const group = groups.find(g => g.id === groupId) || allGroups.find(g => g.id === groupId);
    const action = group?.is_active ? 'dezactiva' : 'activa';

    try {
        const response = await fetch(`/api/product-groups/${groupId}/toggle-active`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showAlert(data.message, 'success');
            await loadGroups();
        } else {
            showAlert(data.error || 'Eroare la actualizare', 'danger');
        }
    } catch (error) {
        showAlert('Eroare: ' + error.message, 'danger');
    }
}

async function deleteGroupPermanent(groupId) {
    const group = groups.find(g => g.id === groupId) || allGroups.find(g => g.id === groupId);

    if (!confirm(`Sigur vrei să ștergi PERMANENT grupul "${group?.group_name}"?\n\nAceastă acțiune NU poate fi anulată!`)) {
        return;
    }

    try {
        const response = await fetch(`/api/product-groups/${groupId}/permanent`, { method: 'DELETE' });
        const data = await response.json();

        if (data.success) {
            showAlert(data.message, 'success');
            await loadGroups();
        } else {
            showAlert(data.error || 'Eroare la ștergere', 'danger');
        }
    } catch (error) {
        showAlert('Eroare: ' + error.message, 'danger');
    }
}

async function addProductToGroup() {
    if (!currentEditGroupId) return;

    const input = document.getElementById('newProductCode');
    const code = input.value.trim();

    if (!code) {
        showAlert('Introduceți un cod SmartBill', 'warning');
        return;
    }

    const btn = document.getElementById('addProductBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
        const response = await fetch(`/api/product-groups/${currentEditGroupId}/add-product`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ smartbill_code: code })
        });

        // Verifică dacă răspunsul e valid JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server-ul a returnat un răspuns invalid');
        }

        const data = await response.json();

        if (data.success) {
            showAlert(data.message, 'success');
            input.value = '';
            // Reîncărcăm lista de produse
            await refreshProductsList(currentEditGroupId);
            // Actualizăm și counter-ul
            const countInput = document.getElementById('editProductsCount');
            countInput.value = parseInt(countInput.value) + 1;
        } else {
            showAlert(data.error || 'Eroare la adăugare', 'danger');
        }
    } catch (error) {
        showAlert('Eroare: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-plus-lg"></i> Adaugă';
    }
}

async function removeProductFromGroup(code) {
    if (!currentEditGroupId) return;

    if (!confirm(`Sigur vrei să elimini produsul "${code}" din acest grup?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/product-groups/${currentEditGroupId}/remove-product`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ smartbill_code: code })
        });

        const data = await response.json();

        if (data.success) {
            showAlert(data.message, 'success');
            // Reîncărcăm lista de produse
            await refreshProductsList(currentEditGroupId);
            // Actualizăm și counter-ul
            const countInput = document.getElementById('editProductsCount');
            countInput.value = Math.max(0, parseInt(countInput.value) - 1);
        } else {
            showAlert(data.error || 'Eroare la eliminare', 'danger');
        }
    } catch (error) {
        showAlert('Eroare: ' + error.message, 'danger');
    }
}

async function refreshProductsList(groupId) {
    try {
        const response = await fetch(`/api/product-groups/${groupId}/products`);
        const data = await response.json();

        document.getElementById('groupProductsList').innerHTML = data.products.length > 0
            ? `<table class="table table-sm table-borderless mb-0">
                <tbody>
                    ${data.products.map(p => `
                        <tr>
                            <td class="text-muted" style="width: 120px;"><code>${p.smartbill_code}</code></td>
                            <td>${p.smartbill_name}</td>
                            <td style="width: 40px;">
                                <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="removeProductFromGroup('${p.smartbill_code}')" title="Elimină din grup">
                                    <i class="bi bi-x"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
               </table>`
            : '<em class="text-muted">Nu există produse asociate</em>';
    } catch (e) {
        document.getElementById('groupProductsList').innerHTML = '<em class="text-danger">Nu s-au putut încărca produsele</em>';
    }
}
</script>
</body>
</html>
